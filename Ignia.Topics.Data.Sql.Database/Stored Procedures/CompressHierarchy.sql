--------------------------------------------------------------------------------------------------------------------------------
-- COMPRESS HIERARCHY
--------------------------------------------------------------------------------------------------------------------------------
-- Remove gaps within nested set model created when non-leaf nodes are deleted
--------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[CompressTopics]
AS

SET NOCOUNT ON;

--------------------------------------------------------------------------------------------------------------------------------
-- MIND THE GAP!
--------------------------------------------------------------------------------------------------------------------------------
UPDATE	Topics
SET	RangeLeft = (
  SELECT	COUNT(*)
  FROM	LftRgt
  WHERE	seq <= RangeLeft
),
	RangeRight = (
  SELECT	COUNT(*)
  FROM	LftRgt
  WHERE	seq <= ISNULL(RangeRight, 0)
);
--------------------------------------------------------------------------------------------------------------------------------
-- COMPRESS TOPICS
--------------------------------------------------------------------------------------------------------------------------------
-- Remove gaps within nested set model created when non-leaf nodes are deleted
--------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[topics_CompressTopics]
AS

SET NOCOUNT ON;

--------------------------------------------------------------------------------------------------------------------------------
-- MIND THE GAP!
--------------------------------------------------------------------------------------------------------------------------------
UPDATE	topics_Topics
SET	RangeLeft = (
  SELECT	COUNT(*)
  FROM	topics_LftRgt
  WHERE	seq <= RangeLeft
),
	RangeRight = (
  SELECT	COUNT(*)
  FROM	topics_LftRgt
  WHERE	seq <= ISNULL(RangeRight, 0)
);
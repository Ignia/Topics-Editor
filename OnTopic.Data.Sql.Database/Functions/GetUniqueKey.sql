--------------------------------------------------------------------------------------------------------------------------------
-- GET UNIQUE KEY
--------------------------------------------------------------------------------------------------------------------------------
-- Given a TopicID, will return the unique key for the topic.
--------------------------------------------------------------------------------------------------------------------------------

CREATE
FUNCTION	[dbo].[GetUniqueKey]
(
	@TopicID		INT
)
RETURNS	VARCHAR(MAX)
AS

BEGIN

  ------------------------------------------------------------------------------------------------------------------------------
  -- DECLARE AND DEFINE VARIABLES
  ------------------------------------------------------------------------------------------------------------------------------
  DECLARE	@RangeLeft		INT
  DECLARE	@RangeRight		INT
  DECLARE	@UniqueKey		VARCHAR(MAX)

  ------------------------------------------------------------------------------------------------------------------------------
  -- FIND RANGE
  ------------------------------------------------------------------------------------------------------------------------------
  SELECT	@RangeLeft		= RangeLeft,
	@RangeRight		= RangeRight
  FROM	Topics
  WHERE	TopicID		= @TopicID

  ------------------------------------------------------------------------------------------------------------------------------
  -- CONSTRUCT UNIQUE KEY
  ------------------------------------------------------------------------------------------------------------------------------
  SELECT	@UniqueKey		= COALESCE(@UniqueKey + ':' + TopicKey, TopicKey)
  FROM	Topics
  CROSS APPLY (
    SELECT	TOP 1
	AttributeValue		AS TopicKey
    FROM	[dbo].[Attributes]
    WHERE	Attributes.TopicID	= Topics.TopicID
      AND	Attributes.AttributeKey	= 'Key'
    ORDER BY	Version DESC
  )	TopicKey
  WHERE	RangeLeft		<= @RangeLeft
  AND	ISNULL(RangeRight, -1)	>= @RangeRight
  ORDER BY	RangeLeft

  ------------------------------------------------------------------------------------------------------------------------------
  -- RETURN VALUE
  ------------------------------------------------------------------------------------------------------------------------------
  RETURN	@UniqueKey

END